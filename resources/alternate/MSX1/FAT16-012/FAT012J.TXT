	   FAT16パッチ ver 0.12
	-------------------------

[ver0.12]
・MSXDOS2の外部コマンドxcopy使用時の不具合を修正しました。
  FAT16パッチのバグを次々見つけてくださるKonamiManさんに感謝。

・xcopy使用時にディレクトリのセクタ番号bit16-23をFIB+38hに保存しますが、
　ここは予約領域で勝手に使ってはいけないことになっています。
　したがって動作は保証されません。　　　　　　

[ver0.11]

・ディレクトリ表示の不具合を修正しました。
  aka KonamiManさんに感謝。

[ver0.10]

・MSXDOS2.20使用時にRAMDISKが使えなかった不具合を修正しました。

[ver0.09]

・FAT16ドライブを見分ける方法を、ルートディレクトリのセクタ数からブートセクタに
　書かれた'FAT16'の文字列に変更。他機種でFAT12フォーマットしたディスクにも対応。
　ブートセクタに'FAT16'の文字を書かないフォーマッタには対応していません。

・書式を変更。
　オプション指定の無いときはFAT16パッチのインストール
　/R　FAT16解除
　/D　各ドライブで使われているFATシステムを表示
　/H  簡単な説明


[ver0.08]

・DOS2フォーマット以外のディスクでファイルやサブディレクトリを削除するとき、
　予備FATの情報を残すようにしました。将来FAT16用のUNDEL.COMが開発されれば、
　削除したファイル等を復活できるでしょう。

 
・DOS2フォーマット以外のディスクでファイルやサブディレクトリを削除すると、UNDEL可能
　フラグをブートセクタ +10に書き込みます。
　DOS1フォーマットディスクでもFAT16パッチ環境でファイルを削除すれば、UNDEL.COMで
　ファイルの復活が出来ます。但し、FAT16ドライブはUNDEL.COMが使えません。

　
・MEGA-SCSIのDSKIO書き替えをやめました。
　ファンクション1BhでFATを専用バッファに読み込むとき、code segmentの0038hをC9hに
　します。DSKIOルーチン内で"EI"していても大丈夫。
　

・オプションを追加
　各ドライブのFAT情報を表示するようにしました。
　ディスクの容量を見れば、そのドライブがFAT12かFAT16かわかると思いますが・・・
　
　FDDでは常に not ready と表示されます。

・パッチを置くアドレスを変更
　ファンクション14h、15hが使えるようになりました。

・ファンクション31hのパラメータ表示を、FAT16ドライブ対応にする。 
　
・MEGA-SCSI用FAT16ドライブのパーティションは CP16.COM で変更できます。

・ATA-IDEはIDEBIOS 2.00以上で動作します。

　
-----------------------------
1.　FAT16パッチとは

　　　MSX-DOS2で16bitFATのメディアを扱えるようにするためのパッチです。
　　　（MSX-DOS2 ver2.2x/ver2.3xに対応しています）
　
　　　FAT16ファイルシステムは最大2Gbのパーティションを扱えます。
　　　大容量ハードディスクをご使用の際は、各インターフェイスに対応した
　　　パーティション設定／切り替えツール等が必要です。

　　・ATA-IDEの各種ツールはSunriseのホームページをご覧下さい。
　　・MegaSCSIのFAT16パーティション設定ツールは、CP16.COMをお使い下さい。
　　　

２．使い方

　　　MSX-DOS2のコマンドラインから、FAT16.COMを起動して下さい。

　　　FAT16 [/R][/D][/H]
　　	
	オプション無し   FAT16パッチを常駐します
	/R   FAT16パッチの解除
	　　 DOS2カーネルをマスタースロットのDISKROMからコピーします。
	/D   各ドライブのFAT情報を表示
		FAT12   12bitFAT
	　　    FAT16   16bitFAT
	/H　 簡単な説明	　　   
	　　    

　（注意）FAT16の常駐／解除の際は、FIBを使ってオープンしているファイル
　　　　　(filehandle 5以上)は必ずクローズして下さい。
	  FAT16パッチは内部でFIBを拡張しています。	

３．Command2.comパッチについて

　　　FAT16ドライブでdirコマンドを使うと、ディスクの空き容量が
　　　正しく表示されません。これはCommand2.comのdirルーチン内の
　　　未使用クラスタ数の換算が１６ビットで行われているためです。
　　　Patchcom.comは未使用クラスタ数の換算を２４ビット化するパッチです。

・使い方
　　　パッチをあてるCommand2.comをカレントドライブに置いて、patch.comを
　　　実行します。
	
	A>PATCHCOM　

　　　なおCommand2.comのバージョンは2.20、2.30、2.31に対応しています。
　　　（注意）パッチあてが終了したら、ＭＳＸをリセットして下さい。　


４．ＭＭ（MOGUさん作）使用について

　　　ＭＭでFAT16ドライブのディレクトリを正しく表示させるためには
　　　下記のパッチをあてて下さい。

　　　MM207_A用パッチ　　MMpatch.com
　　　MM207_K用パッチ　　MMKPATCH.COM


５．エラー表示の意味

　・option error
	オプションの設定が違っています。


　・unknown kernel
	DOS2カーネルはver2.2x ver2.3xに対応していますが、
	未知のカーネルがあるかも知れません。
	このエラーが出たときは、作者までご連絡下さい。


６．FAT16常駐時のDOS2内部処理について

　・FAT12/16共にセクタは２４ビット、FATは１６ビットで処理します。
　
　・ブートセクタに書かれているファイルシステムのタイプを読み、'FAT16'の
　　文字を見つけたときだけFAT16システムと判定されます。FATの読み書きは
　　16ビットで行い、DSKIOコール時Ｃレジスタにセクタ番号のbit16-22をセット
　　します。

　　DOSファンクション2Fh、30hではセクタ番号のbit16-23に0がセットされますので、
　　セクタ0〜FFFFhの範囲で正常アクセスできます。
　
　・ブートセクタに'FAT16'の文字がないときは、FAT12システムと判定されます。
　　FATの読み書きは12ビットで行い、DSKIOコール時ＣレジスタにメディアＩＤを
　　セットします。
　
　・FAT12/16共、データセグメント内のFIBを２バイト多く取ります。
　　FIB内にはファイルの先頭クラスタ番号、ディレクトリのクラスタ番号等の
　　情報が書かれていますが、ディレクトリのセクタ番号も保存されます。
　　FIBを拡張するのは、ディレクトリのセクタ番号bit16-23を保存するためです。
　　FAT16ドライブのアクセスにはFIBを使う方が安全かも知れません。
　

  ・ファンクション31hのパラメータ表示は、FAT16ドライブでデータの格納場所が
　　若干違っています。
	+9,10　セクタ総数は常に00,00
	+18から３バイトにセクタ総数
	+12のFATサイズが00のときは100hの意味です


７．その他

　・FAT16パッチは開発中のプログラムです。
　　使用中にデータ破壊などの事故が起きても責任は取れませんので、
　　動作テスト以外には使わないようにして下さい。
　　　　

　・MSX-DOS2はとても優秀なOSなので、FAT16パッチ無しでもFAT16ドライブの
　　一部を読み書きできます。書き込みをした場合、16ビットFATに12ビットの
　　FATを書くことになり、非常に危険です（経験済み）。
　　FAT16パッチが常駐していない状態でFAT16メディアを扱うときは、十分な
　　注意を払って下さい。
　　

　・dirコマンド高速化のため、ファンクション１Ｂｈ用に専用バッファを
　　使用します。専用バッファはプライマリマッパーＲＡＭからシステム
　　セグメントの割り付けで１６ｋ確保しますが、ＲＡＭ不足でバッファが
　　取れないときは従来通りdiskbufferを使いますので、dirコマンドが
　　もの凄く遅くなります。
　　（ＲＡＭ不足でもエラー表示はしません）


　・FAT16パッチ使用中は下記のDOS2ファンクションが使用禁止になります。
　　（使用した場合はCODE DChのエラーを返します）
　　お使いになるときはFAT16を解除して下さい。

	67h ディスクのフォーマット
	68h ＲＡＭディスクの作成あるいは消去

　　　＊FAT16常駐前にRAMDISKの設定をすれば、RAMDISKは使用できます。


　・他の常駐ソフトがある時
　　FAT16はF2D0hに書かれているセグメントのファンクション67h,68hルーチンと
　　3F00h〜3FFFhに常駐します。
　　MSXCDEX(たろうさん作）はこのアドレスを使わないので、FAT16と同時に使えます。
　　Lunaは使用するアドレスが重なってしまうので、同時には使えません。
　　その他の常駐ソフトについては調べていません。

　・long filename未対応
　　MSX-DOS2のdelコマンドで削除出来るのはshort filenameだけなので、
　　サブディレクトリ内のlong filenameを持ったファイルを全て削除しても、
　　サブディレクトリを削除することが出来ません。
　　Long File Name Killer(Tatsuさん作)を使うか、long filenameをサポートした
　　OSで削除して下さい。
　
　　またdirコマンドでlong filenameを表示させたいときにはldir(Tatsuさん作)が
　　便利です。


　・CHKDSK、UNDELのようなFATをアクセスするコマンドは使えません。念のため。
　　（注意）実験していませんが、絶対に使わないで下さい。


　・一度に大量（１００個とか）のファイルをコピーすると、８５％失敗します。
　



８．謝辞　
　
　FAT16パッチ制作ではいろいろな方にお世話になりました。
　
　Mikasen.さん、Manuel Pazosさん、つじかわさん、たろうさん、SAKAさん
　GYROさん、A to Cさん、ころちさん、めらまんさん、裕之さん、BUSHさん
　Jon De Schrijderさん、KonamiManさん
　FAT16パッチを実験して下さった皆様、ありがとうございました。



不良動作の報告をしていただけると助かります。
　
連絡先
	e-mail : k-mizuo@snow.ucatv.ne.jp
	OKEI

　　